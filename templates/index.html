<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Concorrência - Múltiplas URLs</title>
    <!-- Inclui o Bootstrap para deixar o visual mais bonito e responsivo -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Inclui a biblioteca Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        body { 
            padding-top: 50px; 
            background-color: #f8f9fa; 
            font-family: 'Inter', sans-serif; 
        }
        .container { 
            max-width: 900px; 
            background-color: #fff; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,.05); 
        }
        #loading { 
            display: none; 
            margin-top: 20px; 
        }
        #results { 
            display: none; 
            margin-top: 20px; 
        }
        #errorAlert { 
            display: none; 
            margin-top: 20px; 
        }
        .list-group-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .spinner-border { 
            width: 3rem; 
            height: 3rem; 
        }
        .url-input-group { 
            margin-bottom: 10px; 
        }
        /* Esconde o botão de remover do primeiro campo de URL */
        .url-input-group:first-of-type .remove-url-btn { 
            display: none; 
        } 
        /* Esconde o botão de adicionar dos campos de URL adicionados dinamicamente */
        .url-input-group:not(:first-of-type) .add-url-btn { 
            display: none; 
        } 
        .chart-container { 
            position: relative; 
            height: 300px; 
            width: 100%; 
            margin-bottom: 20px; 
        }
        .individual-result-card { 
            border: 1px solid #e0e0e0; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 20px; 
            background-color: #fdfdfd; 
        }
        .comparison-section { 
            margin-top: 40px; 
            border-top: 2px solid #0d6efd; 
            padding-top: 20px; 
        }
        .comparison-section h2 { 
            color: #0d6efd; 
        }
        .comparison-section ul { 
            list-style-type: none; 
            padding-left: 0; 
        }
        .comparison-section ul li { 
            background-color: #e9f5ff; 
            border-radius: 5px; 
            padding: 8px 12px; 
            margin-bottom: 5px; 
            display: inline-block; 
            margin-right: 5px; 
            font-weight: bold; 
            color: #0d6efd;
        }
        .unique-keywords-list li { 
            background-color: #ffe9f5; 
            color: #dc3545; 
        }
        .common-keywords-list li { 
            background-color: #e9ffe9; 
            color: #198754; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4 text-center text-primary">Analisador de Concorrência (Múltiplas URLs)</h1>
        <p class="text-center text-muted">Insira as URLs dos concorrentes para comparar as palavras-chave mais usadas.</p>
        
        <!-- Área de input de URLs - AGORA COM VALIDAÇÃO VISUAL -->
        <div id="urlInputsContainer">
            <div class="input-group url-input-group has-validation"> 
                <input type="url" class="form-control form-control-lg competitor-url-input" placeholder="Ex: https://www.exemplo.com.br" required>
                <button class="btn btn-outline-secondary add-url-btn" type="button">Adicionar URL</button>
                <button class="btn btn-outline-danger remove-url-btn" type="button">Remover</button>
                <div class="invalid-feedback">
                    Por favor, insira uma URL válida (ex: https://www.site.com).
                </div>
                <div class="valid-feedback">
                    URL válida!
                </div>
            </div>
        </div>
        
        <div class="d-grid gap-2">
            <button class="btn btn-primary btn-lg mt-3" id="analyzeButton">Analisar Todas</button>
        </div>

        <!-- Indicador de carregamento (inicialmente escondido) -->
        <div id="loading" class="text-center" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2 text-muted">Analisando os sites, por favor aguarde...</p>
        </div>

        <!-- Alerta para exibir mensagens de erro (inicialmente escondido) -->
        <div id="errorAlert" class="alert alert-danger" role="alert" style="display: none;">
            <!-- Mensagens de erro serão exibidas aqui via JavaScript -->
        </div>

        <!-- Área para exibir os resultados da análise (inicialmente escondida) -->
        <div id="results" style="display: none;">
            <!-- Resultados Individuais de Cada URL -->
            <h2 class="text-primary mb-4">Resultados Detalhados por URL:</h2>
            <div id="individualResultsContainer">
                <!-- Resultados de cada URL serão inseridos aqui -->
            </div>

            <!-- Seção de Comparação -->
            <div class="comparison-section">
                <h2 class="mb-3">Comparação de Palavras-chave</h2>
                
                <h3 class="text-success">Palavras-chave Comuns a Todas as URLs:</h3>
                <ul id="commonKeywordsList" class="common-keywords-list d-flex flex-wrap gap-2">
                    <!-- Palavras-chave comuns serão inseridas aqui -->
                </ul>

                <h3 class="text-danger mt-4">Palavras-chave Únicas por URL:</h3>
                <div id="uniqueKeywordsContainer">
                    <!-- Palavras-chave únicas para cada URL serão inseridas aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts do Bootstrap (se estiver usando JS deles) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Seu script JavaScript personalizado -->
    <script>
        // Variável global (ou "quase" global, pois está dentro do DOMContentLoaded) para armazenar os dados.
        // É importante que ela seja declarada FORA do listener do analyzeButton, mas dentro do DOMContentLoaded.
        let lastAnalyzedData = null; // Agora armazenará a estrutura completa da resposta do backend

        document.addEventListener('DOMContentLoaded', function() {
            // Seleciona todos os elementos HTML que vamos manipular
            const urlInputsContainer = document.getElementById('urlInputsContainer');
            const analyzeButton = document.getElementById('analyzeButton');
            const loadingDiv = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            const errorAlert = document.getElementById('errorAlert');
            const individualResultsContainer = document.getElementById('individualResultsContainer');
            const commonKeywordsList = document.getElementById('commonKeywordsList');
            const uniqueKeywordsContainer = document.getElementById('uniqueKeywordsContainer');

            // Seleciona os botões de exportação que estarão fixos no HTML
            // (Estes botões são adicionados dinamicamente ao resultsDiv no final do script)
            const exportButtonsContainer = document.createElement('div');
            exportButtonsContainer.className = 'mt-3 text-center';
            exportButtonsContainer.id = 'exportButtonsContainer';
            exportButtonsContainer.style.display = 'none'; // Escondido por padrão
            exportButtonsContainer.innerHTML = `
                <button class="btn btn-success me-2" id="exportCsvButton">Exportar para CSV</button>
                <button class="btn btn-info" id="exportJsonButton">Exportar para JSON</button>
            `;
            resultsDiv.appendChild(exportButtonsContainer); // Adiciona ao final da div de resultados

            const fixedExportCsvButton = document.getElementById('exportCsvButton');
            const fixedExportJsonButton = document.getElementById('exportJsonButton');


            // --- FUNÇÕES AUXILIARES PARA GERENCIAR CAMPOS DE URL E VALIDAÇÃO ---

            // Expressão regular para uma validação de URL mais robusta
            const urlPattern = /^(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/[a-zA-Z0-9]+\.[^\s]{2,}|[a-zA-Z0-9]+\.[^\s]{2,})$/i;

            // Função para validar um único campo de URL e aplicar classes Bootstrap
            function validateUrlInput(inputElement) {
                const url = inputElement.value.trim();
                if (url === '') {
                    inputElement.classList.remove('is-valid', 'is-invalid'); // Remove validação se estiver vazio
                    return true; // Considera vazio como "não validado ainda", não "inválido"
                } else if (urlPattern.test(url)) {
                    inputElement.classList.add('is-valid');
                    inputElement.classList.remove('is-invalid');
                    return true;
                } else {
                    inputElement.classList.add('is-invalid');
                    inputElement.classList.remove('is-valid');
                    return false;
                }
            }

            // Função para adicionar um novo campo de URL
            function addUrlInputField() {
                const newDiv = document.createElement('div');
                newDiv.className = 'input-group url-input-group has-validation'; // Adicionado has-validation
                newDiv.innerHTML = `
                    <input type="url" class="form-control form-control-lg competitor-url-input" placeholder="Ex: https://www.outro-exemplo.com.br" required>
                    <button class="btn btn-outline-secondary add-url-btn" type="button" style="display: none;">Adicionar URL</button>
                    <button class="btn btn-outline-danger remove-url-btn" type="button">Remover</button>
                    <div class="invalid-feedback">
                        Por favor, insira uma URL válida (ex: https://www.site.com).
                    </div>
                    <div class="valid-feedback">
                        URL válida!
                    </div>
                `;
                urlInputsContainer.appendChild(newDiv);
                attachInputListeners(newDiv); // Anexa listeners ao novo campo
            }

            // Função para anexar listeners aos botões de adicionar/remover URL e ao input para validação em tempo real
            function attachInputListeners(container) {
                const addBtn = container.querySelector('.add-url-btn');
                const removeBtn = container.querySelector('.remove-url-btn');
                const urlInput = container.querySelector('.competitor-url-input'); // Pega o input de URL dentro deste container

                if (addBtn) {
                    addBtn.addEventListener('click', addUrlInputField);
                }
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        container.remove();
                    });
                }
                // ADICIONADO: Listener para validação em tempo real enquanto o usuário digita
                if (urlInput) {
                    urlInput.addEventListener('input', () => {
                        validateUrlInput(urlInput);
                    });
                }
            }

            // Anexa listeners ao campo de URL inicial (que já existe no HTML)
            attachInputListeners(urlInputsContainer.querySelector('.url-input-group'));


            // --- Adiciona o "ouvinte de evento" ao botão de análise ---
            analyzeButton.addEventListener('click', async () => {
                const urlInputs = document.querySelectorAll('.competitor-url-input');
                const urls = Array.from(urlInputs)
                                  .map(input => input.value.trim())
                                  .filter(value => value !== ''); // Pega todas as URLs e filtra vazias

                // --- Resetar o estado da interface ---
                resultsDiv.style.display = 'none';
                errorAlert.style.display = 'none';
                individualResultsContainer.innerHTML = ''; // Limpa resultados individuais
                commonKeywordsList.innerHTML = ''; // Limpa lista de comuns
                uniqueKeywordsContainer.innerHTML = ''; // Limpa lista de únicas
                loadingDiv.style.display = 'none'; // Garante que o carregamento esteja escondido no início
                exportButtonsContainer.style.display = 'none'; // Esconde os botões de exportação

                // --- Validação das URLs (Ajustada para validação em tempo real) ---
                if (urls.length === 0) {
                    errorAlert.textContent = 'Por favor, insira pelo menos uma URL para análise.';
                    errorAlert.style.display = 'block';
                    return;
                }

                let allUrlsValid = true;
                const allUrlInputs = document.querySelectorAll('.competitor-url-input'); // Seleciona todos os inputs novamente
                allUrlInputs.forEach(inputElement => {
                    if (!validateUrlInput(inputElement)) { // Valida cada input e verifica se algum é inválido
                        allUrlsValid = false;
                    }
                });

                if (!allUrlsValid) {
                    errorAlert.textContent = 'Por favor, corrija as URLs inválidas antes de analisar.';
                    errorAlert.style.display = 'block';
                    return;
                }

                // --- Iniciar o processo de análise ---
                loadingDiv.style.display = 'block'; // Mostra o indicador de carregamento

                try {
                    // Faz a requisição POST para o backend com a LISTA de URLs
                    const response = await fetch('/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ urls: urls }), // Envia um objeto com a chave 'urls' e a lista
                    });

                    const data = await response.json(); // A resposta agora tem 'individual_results' e 'comparison'
                    lastAnalyzedData = data; // Armazena a resposta completa para exportação

                    if (response.ok) {
                        // Limpa o campo da URL (opcional, se quiser limpar todos os campos após a análise)
                        // urlInputs.forEach(input => input.value = ''); // Descomente se quiser limpar todos os campos

                        // --- Exibir Resultados Individuais ---
                        data.individual_results.forEach((result, index) => {
                            const card = document.createElement('div');
                            card.className = 'individual-result-card';
                            card.innerHTML = `
                                <h3 class="text-info">Análise para: <span class="text-break">${result.url}</span></h3>
                            `;

                            if (result.status === 'error') {
                                card.innerHTML += `<p class="alert alert-warning">${result.message}</p>`;
                            } else {
                                // Container para o gráfico
                                const chartId = `keywordsChart-${index}`;
                                card.innerHTML += `
                                    <div class="chart-container">
                                        <canvas id="${chartId}"></canvas>
                                    </div>
                                    <h4 class="mt-3">Palavras-chave Detalhadas:</h4>
                                    <ul class="list-group keywords-list-${index}"></ul>
                                `;
                                individualResultsContainer.appendChild(card);

                                // Renderiza o gráfico
                                const labels = result.top_keywords.map(item => item[0]);
                                const scores = result.top_keywords.map(item => item[1]);

                                const ctx = document.getElementById(chartId).getContext('2d');
                                new Chart(ctx, { // Não precisamos de window.keywordsChartInstance aqui, pois cada gráfico é único
                                    type: 'bar',
                                    data: {
                                        labels: labels,
                                        datasets: [{
                                            label: 'Score TF-IDF',
                                            data: scores,
                                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                            borderColor: 'rgba(54, 162, 235, 1)',
                                            borderWidth: 1
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        indexAxis: 'y',
                                        plugins: {
                                            legend: { display: false },
                                            tooltip: {
                                                callbacks: {
                                                    label: function(context) {
                                                        let label = context.dataset.label || '';
                                                        if (label) { label += ': '; }
                                                        if (context.parsed.x !== null) { label += context.parsed.x.toFixed(4); }
                                                        return label;
                                                    }
                                                }
                                            }
                                        },
                                        scales: {
                                            x: { beginAtZero: true, title: { display: true, text: 'Score TF-IDF' } },
                                            y: { title: { display: true, text: 'Palavra-chave' } }
                                        }
                                    }
                                });

                                // Preenche a lista detalhada
                                const currentKeywordsList = card.querySelector(`.keywords-list-${index}`);
                                result.top_keywords.forEach(item => {
                                    const li = document.createElement('li');
                                    li.className = 'list-group-item';
                                    li.innerHTML = `<strong>${item[0]}</strong> <span class="badge bg-secondary rounded-pill">${item[1].toFixed(4)}</span>`;
                                    currentKeywordsList.appendChild(li);
                                });
                            }
                            individualResultsContainer.appendChild(card); // Adiciona o card ao container principal
                        });

                        // --- Exibir Palavras-chave Comuns ---
                        data.comparison.common_keywords.forEach(keyword => {
                            const li = document.createElement('li');
                            li.textContent = keyword;
                            commonKeywordsList.appendChild(li);
                        });
                        if (data.comparison.common_keywords.length === 0) {
                            commonKeywordsList.innerHTML = '<li class="text-muted">Nenhuma palavra-chave comum encontrada.</li>';
                        }

                        // --- Exibir Palavras-chave Únicas por URL ---
                        data.comparison.unique_keywords_per_url.forEach(url_unique => {
                            const uniqueCard = document.createElement('div');
                            uniqueCard.className = 'card mb-2';
                            uniqueCard.innerHTML = `
                                <div class="card-header bg-light">Palavras Únicas para: <span class="text-break">${url_unique.url}</span></div>
                                <div class="card-body">
                                    <ul class="unique-keywords-list d-flex flex-wrap gap-2"></ul>
                                </div>
                            `;
                            const uniqueList = uniqueCard.querySelector('ul');
                            if (url_unique.keywords.length === 0) {
                                uniqueList.innerHTML = '<li class="text-muted">Nenhuma palavra-chave única encontrada.</li>';
                            } else {
                                url_unique.keywords.forEach(keyword => {
                                    const li = document.createElement('li');
                                    li.textContent = keyword;
                                    uniqueList.appendChild(li);
                                });
                            }
                            uniqueKeywordsContainer.appendChild(uniqueCard);
                        });

                        resultsDiv.style.display = 'block'; // Mostra a área de resultados principal
                        exportButtonsContainer.style.display = 'block'; // Mostra os botões de exportação

                    } else { // Se a resposta do backend for um erro (código 4xx ou 5xx)
                        errorAlert.textContent = data.error || 'Ocorreu um erro desconhecido ao analisar as URLs.';
                        errorAlert.style.display = 'block';
                        exportButtonsContainer.style.display = 'none'; // Esconde os botões de exportação
                    }
                } catch (error) { // Captura erros de rede
                    errorAlert.textContent = `Erro de conexão ou problema inesperado: ${error.message}. Verifique se o backend está rodando.`;
                    errorAlert.style.display = 'block';
                    exportButtonsContainer.style.display = 'none'; // Esconde os botões de exportação
                } finally {
                    loadingDiv.style.display = 'none'; // Sempre esconde o indicador de carregamento no final
                }
            }); // Fim do addEventListener do analyzeButton


            // ***************************************************************
            // FUNÇÕES DE EXPORTAÇÃO E LISTENERS DE EVENTO PARA ELAS
            // ***************************************************************

            // Função para exportar para CSV
            function exportToCsv() {
                if (!lastAnalyzedData) {
                    alert('Nenhum dado para exportar.');
                    return;
                }

                let csvContent = "Tipo,URL,Palavra-chave,Score TF-IDF\n";

                // Adiciona resultados individuais
                lastAnalyzedData.individual_results.forEach(result => {
                    if (result.status === 'success') {
                        result.top_keywords.forEach(item => {
                            const score = typeof item[1] === 'number' ? item[1].toFixed(4) : item[1];
                            const keyword = `"${item[0].replace(/"/g, '""')}"`;
                            csvContent += `Individual,"${result.url}",${keyword},${score}\n`;
                        });
                    }
                });

                // Adiciona palavras-chave comuns
                if (lastAnalyzedData.comparison.common_keywords.length > 0) {
                    lastAnalyzedData.comparison.common_keywords.forEach(keyword => {
                        const escapedKeyword = `"${keyword.replace(/"/g, '""')}"`;
                        csvContent += `Comum,,${escapedKeyword},\n`; // Sem score para comum
                    });
                }

                // Adiciona palavras-chave únicas
                lastAnalyzedData.comparison.unique_keywords_per_url.forEach(unique_item => {
                    unique_item.keywords.forEach(keyword => {
                        const escapedKeyword = `"${keyword.replace(/"/g, '""')}"`;
                        csvContent += `Única,"${unique_item.url}",${escapedKeyword},\n`; // Sem score para única
                    });
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', 'analise_concorrencia.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // Função para exportar para JSON
            function exportToJson() {
                if (!lastAnalyzedData) {
                    alert('Nenhum dado para exportar.');
                    return;
                }
                const jsonContent = JSON.stringify(lastAnalyzedData, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', 'analise_concorrencia.json');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // Adiciona os ouvintes de evento aos botões de exportação
            fixedExportCsvButton.addEventListener('click', exportToCsv);
            fixedExportJsonButton.addEventListener('click', exportToJson);

        }); // Fim do document.addEventListener('DOMContentLoaded', function() {
    </script>
</body>
</html>
