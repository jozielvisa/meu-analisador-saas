<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Concorrência - MVP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Estilos CSS básicos para a página */
        body { padding-top: 50px; background-color: #f8f9fa; }
        .container { max-width: 800px; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,.05); }
        #loading { display: none; margin-top: 20px; } /* Escondido por padrão */
        #results { display: none; margin-top: 20px; } /* Escondido por padrão */
        #errorAlert { display: none; margin-top: 20px; } /* Escondido por padrão */
        .list-group-item { display: flex; justify-content: space-between; align-items: center; }
        .spinner-border { width: 3rem; height: 3rem; }
    </style>
</head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Concorrência - MVP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* ... seus estilos CSS existentes ... */
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4 text-center text-primary">Analisador de Concorrência (MVP)</h1>
        <p class="text-center text-muted">Insira a URL de um concorrente para ver as palavras-chave mais usadas no conteúdo dele.</p>
        
        <div class="input-group mb-3">
            <input type="url" id="competitorUrl" class="form-control form-control-lg" placeholder="Ex: https://www.exemplo.com.br" required>
            <button class="btn btn-primary btn-lg" id="analyzeButton">Analisar</button>
        </div>

        <div id="loading" class="text-center" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2 text-muted">Analisando o site, por favor aguarde...</p>
        </div>

        <div id="results" style="display: none;">
            <h2 class="text-success">Resultados para: <span id="analyzedUrl" class="text-break"></span></h2>

            <div style="width: 100%; margin: auto; height: 400px;">
                <canvas id="keywordsChart"></canvas>
            </div>

            <h3 class="mt-4">Palavras-chave Detalhadas:</h3>
            <ul class="list-group" id="keywordsList">
                </ul>

            <div class="mt-3 text-center">
                <button class="btn btn-success me-2" id="exportCsvButton" style="display: none;">Exportar para CSV</button>
                <button class="btn btn-info" id="exportJsonButton" style="display: none;">Exportar para JSON</button>
        </div>

        <div id="errorAlert" class="alert alert-danger" role="alert" style="display: none;">
            </div>
    </div>

    </script> <script>
        // Variável global (ou "quase" global, pois está dentro do DOMContentLoaded) para armazenar os dados.
        // É importante que ela seja declarada FORA do listener do analyzeButton, mas dentro do DOMContentLoaded.
        let lastAnalyzedKeywords = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Seleciona todos os elementos HTML que vamos manipular
            const competitorUrlInput = document.getElementById('competitorUrl');
            const analyzeButton = document.getElementById('analyzeButton');
            const loadingDiv = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            const errorAlert = document.getElementById('errorAlert');
            const keywordsList = document.getElementById('keywordsList');
            const analyzedUrlSpan = document.getElementById('analyzedUrl');
            const exportCsvButton = document.getElementById('exportCsvButton'); // Referência ao botão CSV
            const exportJsonButton = document.getElementById('exportJsonButton'); // Referência ao botão JSON


            // --- Adiciona o "ouvinte de evento" ao botão de análise ---
            analyzeButton.addEventListener('click', async () => {
                const url = competitorUrlInput.value.trim();

                // --- Resetar o estado da interface ---
                resultsDiv.style.display = 'none';
                errorAlert.style.display = 'none';
                keywordsList.innerHTML = ''; // Limpa a lista de palavras-chave
                loadingDiv.style.display = 'none'; // Garante que o carregamento esteja escondido no início
                exportCsvButton.style.display = 'none'; // Esconde os botões de exportação
                exportJsonButton.style.display = 'none'; // Esconde os botões de exportação

                // --- Validação da URL (Aprimorada) ---
                if (!url) {
                    errorAlert.textContent = 'Por favor, insira uma URL para análise.';
                    errorAlert.style.display = 'block';
                    return; // Para a execução da função
                }

                const urlPattern = /^(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/[a-zA-Z0-9]+\.[^\s]{2,}|[a-zA-Z0-9]+\.[^\s]{2,})$/i;

                if (!urlPattern.test(url)) {
                    errorAlert.textContent = 'Formato de URL inválido. Por favor, use "https://", "http://", ou um domínio válido como "www.site.com".';
                    errorAlert.style.display = 'block';
                    return; // Para a execução da função
                }

                // --- Iniciar o processo de análise ---
                loadingDiv.style.display = 'block'; // Mostra o indicador de carregamento

                try {
                    // Faz a requisição POST para o backend (para a rota /analyze)
                    const response = await fetch('/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: url }),
                    });

                    const data = await response.json();

                    if (response.ok) { // Se a resposta HTTP for um sucesso (código 2xx)
                        analyzedUrlSpan.textContent = data.url; // Exibe a URL analisada
                        lastAnalyzedKeywords = data.top_keywords; // **ARMAZENA OS DADOS AQUI PARA EXPORTAÇÃO**

                        // Limpa o campo da URL
                        competitorUrlInput.value = ''; //

                        // --- Prepara os dados para o gráfico ---
                        const labels = data.top_keywords.map(item => item[0]);
                        const scores = data.top_keywords.map(item => item[1]);

                        // Destrói o gráfico anterior se ele existir para evitar sobreposição
                        if (window.keywordsChartInstance) {
                            window.keywordsChartInstance.destroy();
                        }

                        // Pega o contexto do canvas para desenhar o gráfico
                        const ctx = document.getElementById('keywordsChart').getContext('2d');

                        // Cria o novo gráfico de barras
                        window.keywordsChartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Score TF-IDF',
                                    data: scores,
                                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                indexAxis: 'y',
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.dataset.label || '';
                                                if (label) { label += ': '; }
                                                if (context.parsed.x !== null) { label += context.parsed.x.toFixed(4); }
                                                return label;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        beginAtZero: true,
                                        title: { display: true, text: 'Score TF-IDF' }
                                    },
                                    y: {
                                        title: { display: true, text: 'Palavra-chave' }
                                    }
                                }
                            }
                        });

                        // --- Ainda exibe a lista detalhada abaixo do gráfico ---
                        keywordsList.innerHTML = ''; // Limpa a lista antes de adicionar novos itens
                        data.top_keywords.forEach(item => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item';
                            li.innerHTML = `<strong>${item[0]}</strong> <span class="badge bg-secondary rounded-pill">${item[1].toFixed(4)}</span>`;
                            keywordsList.appendChild(li);
                        });

                        // Mostra a área de resultados e os botões de exportação
                        resultsDiv.style.display = 'block';
                        exportCsvButton.style.display = 'inline-block'; // Mostra o botão CSV
                        exportJsonButton.style.display = 'inline-block'; // Mostra o botão JSON

                    } else { // Se a resposta do backend for um erro (código 4xx ou 5xx)
                        errorAlert.textContent = data.error || 'Ocorreu um erro desconhecido ao analisar a URL.';
                        errorAlert.style.display = 'block';
                        // Esconde os botões de exportação em caso de erro
                        exportCsvButton.style.display = 'none';
                        exportJsonButton.style.display = 'none';
                    }
                } catch (error) { // Captura erros de rede
                    errorAlert.textContent = `Erro de conexão ou problema inesperado: ${error.message}. Verifique se o backend está rodando.`;
                    errorAlert.style.display = 'block';
                    // Esconde os botões de exportação em caso de erro
                    exportCsvButton.style.display = 'none';
                    exportJsonButton.style.display = 'none';
                } finally {
                    loadingDiv.style.display = 'none'; // Sempre esconde o indicador de carregamento no final
                }
            }); // Fim do addEventListener do analyzeButton


            // ***************************************************************
            // FUNÇÕES DE EXPORTAÇÃO E LISTENERS DE EVENTO PARA ELAS
            // ESTÃO AQUI FORA DO analyzeButton.addEventListener
            // ***************************************************************

            // Função para exportar para CSV
            function exportToCsv() {
                if (lastAnalyzedKeywords.length === 0) {
                    alert('Nenhum dado para exportar.');
                    return;
                }
                let csvContent = "Palavra-chave,Score TF-IDF\n";
                lastAnalyzedKeywords.forEach(item => {
                    const score = typeof item[1] === 'number' ? item[1].toFixed(4) : item[1];
                    const keyword = `"${item[0].replace(/"/g, '""')}"`;
                    csvContent += `${keyword},${score}\n`;
                });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', 'palavras_chave_analise.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // Função para exportar para JSON
            function exportToJson() {
                if (lastAnalyzedKeywords.length === 0) {
                    alert('Nenhum dado para exportar.');
                    return;
                }
                const jsonData = lastAnalyzedKeywords.map(item => ({
                    "palavra_chave": item[0],
                    "score_tf_idf": parseFloat(item[1].toFixed(4))
                }));
                const jsonContent = JSON.stringify(jsonData, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', 'palavras_chave_analise.json');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // Adiciona os ouvintes de evento aos botões de exportação
            exportCsvButton.addEventListener('click', exportToCsv);
            exportJsonButton.addEventListener('click', exportToJson);

        }); // Fim do document.addEventListener('DOMContentLoaded', function() {
    </script>
</body>
</html>