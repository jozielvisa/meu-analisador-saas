<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Concorrência - Login</title>
    <!-- Inclui o Bootstrap para deixar o visual mais bonito e responsivo -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Inclui a biblioteca Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importa os módulos necessários do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        // Importa Firestore (para uso futuro, já deixamos pronto)
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Sua configuração do Firebase (COLE AQUI O SEU firebaseConfig)
        const firebaseConfig = {
            apiKey: "SUA_API_KEY", // Exemplo: "AIzaSyC_xxxxxxxxxxxxxxxxxxxxxxxxxxxx"
            authDomain: "seu-projeto.firebaseapp.com", // Exemplo: "seu-projeto.firebaseapp.com"
            projectId: "seu-project-id", // Exemplo: "seu-project-id"
            storageBucket: "seu-projeto.appspot.com", // Exemplo: "seu-projeto.appspot.com"
            messagingSenderId: "SEU_SENDER_ID", // Exemplo: "1234567890"
            appId: "SEU_APP_ID", // Exemplo: "1:1234567890:web:abcdef1234567890"
            measurementId: "SEU_MEASUREMENT_ID" // Opcional
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); // Inicializa Firestore

        // Torna auth e db acessíveis globalmente para o restante do script
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.onAuthStateChanged = onAuthStateChanged; // Torna onAuthStateChanged acessível
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
    </script>

    <style>
        body {
            padding-top: 50px;
            background-color: #f8f9fa;
            font-family: 'Inter', sans-serif;
        }
        .container {
            max-width: 900px;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,.05);
        }
        #loading {
            display: none;
            margin-top: 20px;
        }
        #results {
            display: none;
            margin-top: 20px;
        }
        #errorAlert {
            display: none;
            margin-top: 20px;
        }
        .list-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .url-input-group {
            margin-bottom: 10px;
        }
        /* Esconde o botão de remover do primeiro campo de URL */
        .url-input-group:first-of-type .remove-url-btn {
            display: none;
        }
        /* Esconde o botão de adicionar dos campos de URL adicionados dinamicamente */
        .url-input-group:not(:first-of-type) .add-url-btn {
            display: none;
        }
        .chart-container {
            position: relative;
            height: 300px; /* Altura fixa para o gráfico */
            width: 100%;
            margin-bottom: 20px;
        }
        .individual-result-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #fdfdfd;
        }
        .comparison-section {
            margin-top: 40px;
            border-top: 2px solid #0d6efd;
            padding-top: 20px;
        }
        .comparison-section h2 {
            color: #0d6efd;
        }
        .comparison-section ul {
            list-style-type: none;
            padding-left: 0;
        }
        .comparison-section ul li {
            background-color: #e9f5ff;
            border-radius: 5px;
            padding: 8px 12px;
            margin-bottom: 5px;
            display: inline-block;
            margin-right: 5px;
            font-weight: bold;
            color: #0d6efd;
        }
        .unique-keywords-list li {
            background-color: #ffe9f5;
            color: #dc3545;
        }
        .common-keywords-list li {
            background-color: #e9ffe9;
            color: #198754;
        }
        /* Estilo para o badge de idioma */
        .badge.bg-primary {
            font-size: 0.8em; /* Ajusta o tamanho da fonte do badge */
            vertical-align: middle; /* Alinha verticalmente com o texto */
        }
        /* Estilos para a barra de navegação de autenticação */
        .auth-controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
            gap: 10px;
        }
        #userInfo {
            font-weight: bold;
            color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Controles de Autenticação -->
        <div class="auth-controls">
            <span id="userInfo" style="display: none;"></span>
            <button class="btn btn-outline-primary" id="loginButton" data-bs-toggle="modal" data-bs-target="#loginModal" style="display: none;">Login</button>
            <button class="btn btn-primary" id="signupButton" data-bs-toggle="modal" data-bs-target="#signupModal" style="display: none;">Registrar</button>
            <button class="btn btn-outline-danger" id="logoutButton" style="display: none;">Sair</button>
        </div>

        <h1 class="mb-4 text-center text-primary">Analisador de Concorrência (Múltiplas URLs)</h1>
        <p class="text-center text-muted">Insira as URLs dos concorrentes para comparar as palavras-chave mais usadas.</p>
        
        <!-- Área de input de URLs - AGORA COM VALIDAÇÃO VISUAL -->
        <div id="urlInputsContainer">
            <div class="input-group url-input-group has-validation">
                <input type="url" class="form-control form-control-lg competitor-url-input" placeholder="Ex: https://www.exemplo.com.br" required>
                <button class="btn btn-outline-secondary add-url-btn" type="button">Adicionar URL</button>
                <button class="btn btn-outline-danger remove-url-btn" type="button">Remover</button>
                <div class="invalid-feedback">
                    Por favor, insira uma URL válida (ex: https://www.site.com).
                </div>
                <div class="valid-feedback">
                    URL válida!
                </div>
            </div>
        </div>
        
        <div class="d-grid gap-2">
            <button class="btn btn-primary btn-lg mt-3" id="analyzeButton">Analisar Todas</button>
        </div>

        <!-- Indicador de carregamento (inicialmente escondido) -->
        <div id="loading" class="text-center" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2 text-muted">Analisando os sites, por favor aguarde...</p>
        </div>

        <!-- Alerta para exibir mensagens de erro (inicialmente escondido) -->
        <div id="errorAlert" class="alert alert-danger" role="alert" style="display: none;">
            <!-- Mensagens de erro serão exibidas aqui via JavaScript -->
        </div>

        <!-- Área para exibir os resultados da análise (inicialmente escondida) -->
        <div id="results" style="display: none;">
            <!-- Resultados Individuais de Cada URL -->
            <h2 class="text-primary mb-4">Resultados Detalhados por URL:</h2>
            <div id="individualResultsContainer">
                <!-- Resultados de cada URL serão inseridos aqui -->
            </div>

            <!-- Seção de Comparação -->
            <div class="comparison-section">
                <h2 class="mb-3">Comparação de Palavras-chave</h2>
                
                <h3 class="text-success">Palavras-chave Comuns a Todas as URLs:</h3>
                <ul id="commonKeywordsList" class="common-keywords-list d-flex flex-wrap gap-2">
                    <!-- Palavras-chave comuns serão inseridas aqui -->
                </ul>

                <h3 class="text-danger mt-4">Palavras-chave Únicas por URL:</h3>
                <div id="uniqueKeywordsContainer">
                    <!-- Palavras-chave únicas para cada URL serão inseridas aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Login -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Senha</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <div id="loginError" class="alert alert-danger" style="display: none;"></div>
                        <button type="submit" class="btn btn-primary">Entrar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Registro -->
    <div class="modal fade" id="signupModal" tabindex="-1" aria-labelledby="signupModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="signupModalLabel">Registrar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="signupForm">
                        <div class="mb-3">
                            <label for="signupEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="signupEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="signupPassword" class="form-label">Senha</label>
                            <input type="password" class="form-control" id="signupPassword" required>
                        </div>
                        <div id="signupError" class="alert alert-danger" style="display: none;"></div>
                        <button type="submit" class="btn btn-primary">Registrar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts do Bootstrap (se estiver usando JS deles) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Seu script JavaScript personalizado -->
    <script>
        // Variável global para armazenar os últimos dados de palavras-chave analisados
        let lastAnalyzedData = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Seleciona todos os elementos HTML que vamos manipular
            const urlInputsContainer = document.getElementById('urlInputsContainer');
            const analyzeButton = document.getElementById('analyzeButton');
            const loadingDiv = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            const errorAlert = document.getElementById('errorAlert');
            const individualResultsContainer = document.getElementById('individualResultsContainer');
            const commonKeywordsList = document.getElementById('commonKeywordsList');
            const uniqueKeywordsContainer = document.getElementById('uniqueKeywordsContainer');

            // Elementos de Autenticação
            const userInfoSpan = document.getElementById('userInfo');
            const loginButton = document.getElementById('loginButton');
            const signupButton = document.getElementById('signupButton');
            const logoutButton = document.getElementById('logoutButton');

            // Formulários de Autenticação
            const loginForm = document.getElementById('loginForm');
            const loginEmailInput = document.getElementById('loginEmail');
            const loginPasswordInput = document.getElementById('loginPassword');
            const loginErrorDiv = document.getElementById('loginError');

            const signupForm = document.getElementById('signupForm');
            const signupEmailInput = document.getElementById('signupEmail');
            const signupPasswordInput = document.getElementById('signupPassword');
            const signupErrorDiv = document.getElementById('signupError');

            // Seleciona os botões de exportação que estarão fixos no HTML
            const exportButtonsContainer = document.createElement('div');
            exportButtonsContainer.className = 'mt-3 text-center';
            exportButtonsContainer.id = 'exportButtonsContainer';
            exportButtonsContainer.style.display = 'none'; // Escondido por padrão
            exportButtonsContainer.innerHTML = `
                <button class="btn btn-success me-2" id="exportCsvButton">Exportar para CSV</button>
                <button class="btn btn-info" id="exportJsonButton">Exportar para JSON</button>
            `;
            resultsDiv.appendChild(exportButtonsContainer); // Adiciona ao final da div de resultados

            const fixedExportCsvButton = document.getElementById('exportCsvButton');
            const fixedExportJsonButton = document.getElementById('exportJsonButton');


            // --- FUNÇÕES AUXILIARES PARA GERENCIAR CAMPOS DE URL E VALIDAÇÃO ---

            // Expressão regular para uma validação de URL mais robusta
            const urlPattern = /^(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/[a-zA-Z0-9]+\.[^\s]{2,}|[a-zA-Z0-9]+\.[^\s]{2,})$/i;

            // Função para validar um único campo de URL e aplicar classes Bootstrap
            function validateUrlInput(inputElement) {
                const url = inputElement.value.trim();
                if (url === '') {
                    inputElement.classList.remove('is-valid', 'is-invalid');
                    return true;
                } else if (urlPattern.test(url)) {
                    inputElement.classList.add('is-valid');
                    inputElement.classList.remove('is-invalid');
                    return true;
                } else {
                    inputElement.classList.add('is-invalid');
                    inputElement.classList.remove('is-valid');
                    return false;
                }
            }

            // Função para adicionar um novo campo de URL
            function addUrlInputField() {
                const newDiv = document.createElement('div');
                newDiv.className = 'input-group url-input-group has-validation';
                newDiv.innerHTML = `
                    <input type="url" class="form-control form-control-lg competitor-url-input" placeholder="Ex: https://www.outro-exemplo.com.br" required>
                    <button class="btn btn-outline-secondary add-url-btn" type="button" style="display: none;">Adicionar URL</button>
                    <button class="btn btn-outline-danger remove-url-btn" type="button">Remover</button>
                    <div class="invalid-feedback">
                        Por favor, insira uma URL válida (ex: https://www.site.com).
                    </div>
                    <div class="valid-feedback">
                        URL válida!
                    </div>
                `;
                urlInputsContainer.appendChild(newDiv);
                attachInputListeners(newDiv);
            }

            // Função para anexar listeners aos botões de adicionar/remover URL e ao input para validação em tempo real
            function attachInputListeners(container) {
                const addBtn = container.querySelector('.add-url-btn');
                const removeBtn = container.querySelector('.remove-url-btn');
                const urlInput = container.querySelector('.competitor-url-input');

                if (addBtn) {
                    addBtn.addEventListener('click', addUrlInputField);
                }
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        container.remove();
                    });
                }
                if (urlInput) {
                    urlInput.addEventListener('input', () => {
                        validateUrlInput(urlInput);
                    });
                }
            }

            // Anexa listeners ao campo de URL inicial
            attachInputListeners(urlInputsContainer.querySelector('.url-input-group'));


            // --- Lógica de Autenticação Firebase ---

            // Listener de estado de autenticação
            window.onAuthStateChanged(window.firebaseAuth, (user) => {
                if (user) {
                    // Usuário logado
                    userInfoSpan.textContent = `Olá, ${user.email}!`;
                    userInfoSpan.style.display = 'inline';
                    loginButton.style.display = 'none';
                    signupButton.style.display = 'none';
                    logoutButton.style.display = 'inline-block';
                    // Habilitar funcionalidades da aplicação (análise, etc.)
                    analyzeButton.disabled = false;
                } else {
                    // Usuário deslogado
                    userInfoSpan.style.display = 'none';
                    loginButton.style.display = 'inline-block';
                    signupButton.style.display = 'inline-block';
                    logoutButton.style.display = 'none';
                    // Desabilitar funcionalidades da aplicação
                    analyzeButton.disabled = true;
                    // Limpar resultados e alerts
                    resultsDiv.style.display = 'none';
                    errorAlert.style.display = 'none';
                    loadingDiv.style.display = 'none';
                    exportButtonsContainer.style.display = 'none';
                }
            });

            // Lógica de Registro
            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = signupEmailInput.value;
                const password = signupPasswordInput.value;
                signupErrorDiv.style.display = 'none';

                try {
                    // Usa o SDK do Firebase Client para criar o usuário
                    const userCredential = await window.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                    // Opcional: Enviar para o backend para criar um registro no Admin SDK se necessário (já fizemos isso no backend, mas o cliente SDK é o que realmente autentica)
                    // const response = await fetch('/signup', { /* ... */ });
                    alert('Registro bem-sucedido! Você está logado.');
                    // Fecha o modal de registro
                    const signupModal = bootstrap.Modal.getInstance(document.getElementById('signupModal'));
                    if (signupModal) signupModal.hide();
                } catch (error) {
                    let errorMessage = 'Erro no registro.';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Este email já está em uso.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'A senha é muito fraca (mínimo 6 caracteres).';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'O formato do email é inválido.';
                    }
                    signupErrorDiv.textContent = errorMessage;
                    signupErrorDiv.style.display = 'block';
                    console.error("Erro de registro:", error);
                }
            });

            // Lógica de Login
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = loginEmailInput.value;
                const password = loginPasswordInput.value;
                loginErrorDiv.style.display = 'none';

                try {
                    // Usa o SDK do Firebase Client para fazer login
                    const userCredential = await window.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                    // Opcional: Enviar para o backend para obter um custom token se necessário para outras APIs (já fizemos isso no backend)
                    // const response = await fetch('/login', { /* ... */ });
                    alert('Login bem-sucedido!');
                    // Fecha o modal de login
                    const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                    if (loginModal) loginModal.hide();
                } catch (error) {
                    let errorMessage = 'Erro no login.';
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = 'Email ou senha incorretos.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'O formato do email é inválido.';
                    }
                    loginErrorDiv.textContent = errorMessage;
                    loginErrorDiv.style.display = 'block';
                    console.error("Erro de login:", error);
                }
            });

            // Lógica de Logout
            logoutButton.addEventListener('click', async () => {
                try {
                    await window.signOut(window.firebaseAuth);
                    alert('Você foi desconectado.');
                } catch (error) {
                    console.error("Erro ao fazer logout:", error);
                    alert('Erro ao fazer logout. Tente novamente.');
                }
            });


            // --- Lógica de Análise (EXISTENTE, AGORA DENTRO DO CONTEXTO DE AUTENTICAÇÃO) ---
            analyzeButton.addEventListener('click', async () => {
                // Verifica se o usuário está logado antes de permitir a análise
                if (!window.firebaseAuth.currentUser) {
                    errorAlert.textContent = 'Você precisa estar logado para realizar análises.';
                    errorAlert.style.display = 'block';
                    return;
                }

                const urlInputs = document.querySelectorAll('.competitor-url-input');
                const urls = Array.from(urlInputs)
                                  .map(input => input.value.trim())
                                  .filter(value => value !== '');

                // --- Resetar o estado da interface ---
                resultsDiv.style.display = 'none';
                errorAlert.style.display = 'none';
                individualResultsContainer.innerHTML = '';
                commonKeywordsList.innerHTML = '';
                uniqueKeywordsContainer.innerHTML = '';
                loadingDiv.style.display = 'none';
                exportButtonsContainer.style.display = 'none';

                // --- Validação das URLs ---
                if (urls.length === 0) {
                    errorAlert.textContent = 'Por favor, insira pelo menos uma URL para análise.';
                    errorAlert.style.display = 'block';
                    return;
                }

                let allUrlsValid = true;
                const allUrlInputs = document.querySelectorAll('.competitor-url-input');
                allUrlInputs.forEach(inputElement => {
                    if (!validateUrlInput(inputElement)) {
                        allUrlsValid = false;
                    }
                });

                if (!allUrlsValid) {
                    errorAlert.textContent = 'Por favor, corrija as URLs inválidas antes de analisar.';
                    errorAlert.style.display = 'block';
                    return;
                }

                loadingDiv.style.display = 'block';

                try {
                    const response = await fetch('/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ urls: urls }),
                    });

                    const data = await response.json();
                    lastAnalyzedData = data;

                    if (response.ok) {
                        urlInputs.forEach(input => {
                            input.value = '';
                            input.classList.remove('is-valid', 'is-invalid');
                        });

                        data.individual_results.forEach((result, index) => {
                            const card = document.createElement('div');
                            card.className = 'individual-result-card';
                            card.innerHTML = `
                                <h3 class="text-info">Análise para: <span class="text-break">${result.url}</span></h3>
                            `;

                            if (result.status === 'error') {
                                card.innerHTML += `<p class="alert alert-warning">${result.message}</p>`;
                            } else {
                                const detectedLangDisplay = result.detected_language ?
                                    `<span class="badge bg-primary ms-2">${result.detected_language.toUpperCase()}</span>` : '';

                                card.innerHTML += `
                                    <h5 class="mt-3">Idioma Detectado: ${detectedLangDisplay}</h5>
                                    <div class="chart-container">
                                        <canvas id="keywordsChart-${index}"></canvas>
                                    </div>
                                    <h4 class="mt-3">Palavras-chave Detalhadas:</h4>
                                    <ul class="list-group keywords-list-${index}"></ul>
                                `;
                                individualResultsContainer.appendChild(card);

                                const labels = result.top_keywords.map(item => item[0]);
                                const scores = result.top_keywords.map(item => item[1]);

                                const ctx = document.getElementById(`keywordsChart-${index}`).getContext('2d');
                                new Chart(ctx, {
                                    type: 'bar',
                                    data: {
                                        labels: labels,
                                        datasets: [{
                                            label: 'Score TF-IDF',
                                            data: scores,
                                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                            borderColor: 'rgba(54, 162, 235, 1)',
                                            borderWidth: 1
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        indexAxis: 'y',
                                        plugins: {
                                            legend: { display: false },
                                            tooltip: {
                                                callbacks: {
                                                    label: function(context) {
                                                        let label = context.dataset.label || '';
                                                        if (label) { label += ': '; }
                                                        if (context.parsed.x !== null) { label += context.parsed.x.toFixed(4); }
                                                        return label;
                                                    }
                                                }
                                            }
                                        },
                                        scales: {
                                            x: { beginAtZero: true, title: { display: true, text: 'Score TF-IDF' } },
                                            y: { title: { display: true, text: 'Palavra-chave' } }
                                        }
                                    }
                                });

                                const currentKeywordsList = card.querySelector(`.keywords-list-${index}`);
                                result.top_keywords.forEach(item => {
                                    const li = document.createElement('li');
                                    li.className = 'list-group-item';
                                    li.innerHTML = `<strong>${item[0]}</strong> <span class="badge bg-secondary rounded-pill">${item[1].toFixed(4)}</span>`;
                                    currentKeywordsList.appendChild(li);
                                });
                            }
                            individualResultsContainer.appendChild(card);
                        });

                        if (data.comparison.common_keywords.length === 0) {
                            commonKeywordsList.innerHTML = '<li class="text-muted">Não foram encontradas palavras-chave comuns entre os sites analisados.</li>';
                        } else {
                            const sortedCommonKeywords = data.comparison.common_keywords.sort();
                            sortedCommonKeywords.forEach(keyword => {
                                const li = document.createElement('li');
                                li.textContent = keyword;
                                commonKeywordsList.appendChild(li);
                            });
                        }

                        data.comparison.unique_keywords_per_url.forEach(url_unique => {
                            const uniqueCard = document.createElement('div');
                            uniqueCard.className = 'card mb-2';
                            uniqueCard.innerHTML = `
                                <div class="card-header bg-light">Palavras Únicas para: <span class="text-break">${url_unique.url}</span></div>
                                <div class="card-body">
                                    <ul class="unique-keywords-list d-flex flex-wrap gap-2"></ul>
                                </div>
                            `;
                            const uniqueList = uniqueCard.querySelector('ul');
                            if (url_unique.keywords.length === 0) {
                                uniqueList.innerHTML = '<li class="text-muted">Nenhuma palavra-chave única encontrada para esta URL.</li>';
                            } else {
                                const sortedUniqueKeywords = url_unique.keywords.sort();
                                sortedUniqueKeywords.forEach(keyword => {
                                    const li = document.createElement('li');
                                    li.textContent = keyword;
                                    uniqueList.appendChild(li);
                                });
                            }
                            uniqueKeywordsContainer.appendChild(uniqueCard);
                        });

                        resultsDiv.style.display = 'block';
                        exportButtonsContainer.style.display = 'block';

                    } else {
                        errorAlert.textContent = data.error || 'Ocorreu um erro desconhecido ao analisar as URLs.';
                        errorAlert.style.display = 'block';
                        exportButtonsContainer.style.display = 'none';
                    }
                } catch (error) {
                    errorAlert.textContent = `Erro de conexão ou problema inesperado: ${error.message}. Verifique se o backend está rodando.`;
                    errorAlert.style.display = 'block';
                    exportButtonsContainer.style.display = 'none';
                } finally {
                    loadingDiv.style.display = 'none';
                }
            });


            // ***************************************************************
            // FUNÇÕES DE EXPORTAÇÃO (EXISTENTES)
            // ***************************************************************

            function exportToCsv() {
                if (!lastAnalyzedData) {
                    alert('Nenhum dado para exportar.');
                    return;
                }

                let csvContent = "Tipo,URL,Palavra-chave,Score TF-IDF\n";

                lastAnalyzedData.individual_results.forEach(result => {
                    if (result.status === 'success') {
                        result.top_keywords.forEach(item => {
                            const score = typeof item[1] === 'number' ? item[1].toFixed(4) : item[1];
                            const keyword = `"${item[0].replace(/"/g, '""')}"`;
                            csvContent += `Individual,"${result.url}",${keyword},${score}\n`;
                        });
                    }
                });

                if (lastAnalyzedData.comparison.common_keywords.length > 0) {
                    lastAnalyzedData.comparison.common_keywords.forEach(keyword => {
                        const escapedKeyword = `"${keyword.replace(/"/g, '""')}"`;
                        csvContent += `Comum,,${escapedKeyword},\n`;
                    });
                }

                lastAnalyzedData.comparison.unique_keywords_per_url.forEach(unique_item => {
                    unique_item.keywords.forEach(keyword => {
                        const escapedKeyword = `"${keyword.replace(/"/g, '""')}"`;
                        csvContent += `Única,"${unique_item.url}",${escapedKeyword},\n`;
                    });
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', 'analise_concorrencia.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function exportToJson() {
                if (!lastAnalyzedData) {
                    alert('Nenhum dado para exportar.');
                    return;
                }
                const jsonContent = JSON.stringify(lastAnalyzedData, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', 'analise_concorrencia.json');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            fixedExportCsvButton.addEventListener('click', exportToCsv);
            fixedExportJsonButton.addEventListener('click', exportToJson);

        }); // Fim do document.addEventListener('DOMContentLoaded', function() {
    </script>
</body>
</html>
